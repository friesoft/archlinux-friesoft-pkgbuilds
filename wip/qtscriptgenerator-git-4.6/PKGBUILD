# Contributor: Dylon Edwards <deltaecho@archlinux.us>

pkgname=qtscriptgenerator-git-4.6
pkgver=20090719
pkgrel=1

pkgdesc="A tool that generates Qt 4.6 bindings for Qt Script."
url="http://code.google.com/p/qtscriptgenerator/"
license=('GPL')

source=( 'qtscriptgenerator-git.patch' )
md5sums=( '11d77ac547c4bc9e6f536058c6288964' )

arch=('i686' 'x86_64')

depends=( "qt" )
makedepends=( "git" )

provides=( "qtscriptgenerator-git=${pkgver}" "qtscriptgenerator=${pkgver}" )
conflicts=( "qtscriptgenerator" )

_gitroot="git://labs.trolltech.com/qtscriptgenerator"
_gitname="qtscriptgenerator-git"

# Valid options are "true" or "false"
INSTALL_DOCS="true"

build() {

	# Export the include dir
	export QTDIR="/usr"
	export INCLUDE="/usr/include"
	
	msg "Connecting to the GIT server..."
	if [ -d ${_gitname}/.git ]; then
		( cd ${_gitname} && git pull )
	else
		git clone ${_gitroot} ${_gitname}
		cd ${_gitname}
		git remote add "4.6" git://gitorious.org/qt-labs/qtscriptgenerator.git
		git checkout -b "4.6"/master
		git pull "4.6" master
		cd ..
	fi

	# Patch a file that lacks an #include,
	#+ and another to disable phonon.
	cp -a ${_gitname} ${_gitname}-build && cd $_
	patch -Np1 -i ../qtscriptgenerator-git.patch || return 1
	

	#  Compile and run the generator
	#+ to "generate" the source and
	#+ header files for the bindings
	cd ${srcdir}/${_gitname}-build/generator
	qmake && make
	./generator

	#  Compile the bindings
	cd ${srcdir}/${_gitname}-build/qtbindings
	qmake && make

	#  Install the qtscript bindings
	cd ${srcdir}/${_gitname}-build/plugins/script
	mkdir -p ${pkgdir}/usr/lib/qt/plugins/script
	cp -a ./* ${pkgdir}/usr/lib/qt/plugins/script

	#  Determine whether to install the documentation
	if [ "${INSTALL_DOCS}" == "true" ]; then
		mkdir -p ${pkgdir}/usr/share/doc/qtscript
		cd ${srcdir}/${_gitname}-build/doc
		cp -a ./* ${pkgdir}/usr/share/doc/qtscript
	fi

	cd ${srcdir}
	rm -rf ${_gitname}-build
}
